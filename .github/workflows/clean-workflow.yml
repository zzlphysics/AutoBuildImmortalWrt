name: Cleanup Old Workflow Runs

on:
  workflow_dispatch:
    inputs:
      keep_days:
        description: "ä¿ç•™æœ€è¿‘å¤šå°‘å¤©ï¼ˆé»˜è®¤ 1ï¼‰"
        required: false
        default: "1"

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write

    steps:
      - name: å®‰è£… jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: åˆ é™¤æŒ‡å®šå¤©æ•°å‰çš„å·²å®Œæˆè¿è¡Œ
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          KEEP_DAYS: ${{ github.event.inputs.keep_days }}
        run: |
          : "${KEEP_DAYS:=1}"
          THRESHOLD="$(date -u -d "${KEEP_DAYS} days ago" '+%Y-%m-%dT%H:%M:%SZ')"
          echo "é˜ˆå€¼æ—¶é—´(UTC)ï¼š$THRESHOLD"

          RUN_IDS=$(gh api -X GET "repos/${GITHUB_REPOSITORY}/actions/runs" \
                    --paginate -F per_page=100 \
                    --jq '.workflow_runs[]
                          | select(.status=="completed" and .created_at < "'"$THRESHOLD"'")
                          | .id')

          if [ -z "$RUN_IDS" ]; then
            echo "âœ… æ²¡æœ‰å¯åˆ é™¤çš„è¿è¡Œ"
            exit 0
          fi

          echo "å¾…åˆ é™¤è¿è¡Œæ•°é‡ï¼š$(wc -w <<< "$RUN_IDS")"
          for ID in $RUN_IDS; do
            echo "ğŸ—‘ æ­£åœ¨åˆ é™¤è¿è¡Œ ID: $ID"
            gh api -X DELETE "repos/${GITHUB_REPOSITORY}/actions/runs/${ID}" || {
              echo "âš ï¸ åˆ é™¤å¤±è´¥ï¼š$IDï¼ˆå°†ç»§ç»­å¤„ç†å…¶ä»–é¡¹ï¼‰"
            }
            sleep 0.2
          done

          echo "ğŸ‰ æ¸…ç†å®Œæˆ"
